<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Prompt Final Fix — Generate Works</title>
<style>
  :root{--bg:#f6f9ff;--card:#fff;--accent:#0b63ff;--muted:#556070;--radius:10px}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#081227;padding:18px}
  .wrap{max-width:1000px;margin:0 auto}
  h1{margin:0 0 6px;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:14px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr } }
  .card{background:var(--card);padding:12px;border-radius:var(--radius);box-shadow:0 6px 20px rgba(8,20,40,0.06);border:1px solid rgba(11,99,255,0.04)}
  label{display:block;font-weight:700;margin-bottom:6px}
  input[type="text"], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef9;background:#fbfdff}
  textarea{min-height:180px;resize:vertical;white-space:pre-wrap}
  .row{display:flex;gap:8px}
  .col{flex:1}
  button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,99,255,0.12)}
  .expert-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .expert-item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:#fbfdff;border:1px solid rgba(11,99,255,0.03)}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Prompt Final Fix — Generate Works</h1>
  <div class="muted">Upload foto → pilih expert → Generate → Copy. Kalau butuh GPS, jalankan dari localhost/HTTPS.</div>

  <div style="height:12px"></div>

  <div class="grid">
    <!-- LEFT -->
    <div>
      <div class="card">
        <label>1) Upload foto (camera / gallery)</label>
        <div class="row">
          <div class="col"><input id="cameraInput" type="file" accept="image/*" capture="environment"></div>
          <div class="col"><input id="galleryInput" type="file" accept="image/*"></div>
        </div>
        <img id="preview" style="display:none;margin-top:10px;max-width:100%;border-radius:8px"/>

        <div style="height:10px"></div>

        <div class="row">
          <div class="col">
            <label>Latitude</label>
            <input id="lat" type="text" placeholder="Latitude (EXIF or device)">
          </div>
          <div class="col">
            <label>Longitude</label>
            <input id="lon" type="text" placeholder="Longitude (EXIF or device)">
          </div>
        </div>

        <div style="height:8px"></div>

        <div class="row">
          <div class="col">
            <label>Timestamp</label>
            <input id="timestamp" type="text" placeholder="Timestamp (ISO)">
          </div>
          <div class="col" style="display:flex;align-items:flex-end;gap:8px">
            <button id="getGeoBtn" class="ghost">Ambil GPS Perangkat</button>
            <button id="clearBtn" class="ghost">Clear</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <label>2) Pilih ahli (boleh multiple)</label>
        <div id="expertArea" class="expert-grid"></div>

        <div style="height:10px"></div>
        <label>Catatan (opsional)</label>
        <textarea id="note" placeholder="Contoh: 'Gerbang rusak, lampu mati, jam 02:12'"></textarea>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <label>Preset (opsional)</label>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="presetName" type="text" placeholder="Nama preset">
          <button id="savePresetBtn" class="ghost">Save</button>
        </div>
        <div id="presetList" style="min-height:80px;border:1px dashed rgba(11,99,255,0.06);padding:8px;border-radius:8px;background:#fff" class="small">Belum ada preset.</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="applyPresetBtn" class="ghost">Apply</button>
          <button id="deletePresetBtn" class="ghost">Delete</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <label>Pengaturan Prompt</label>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <label style="display:flex;align-items:center;gap:8px"><input id="aggressiveToggle" type="checkbox"> Aggressive Mode</label>
        </div>
        <div style="display:flex;gap:8px">
          <button id="generateBtn">Generate Prompt</button>
          <button id="copyUserBtn" class="ghost">Copy User</button>
          <button id="copyBothBtn" class="ghost">Copy System+User</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <label>Hasil Prompt</label>
        <textarea id="promptOutput" placeholder="Tekan Generate untuk membuat prompt..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="mockBtn" class="ghost">Mock Output</button>
          <button id="downloadBtn" class="ghost">Download</button>
        </div>
      </div>
    </div>
  </div>

  <div style="height:10px"></div>
  <div class="muted">Catatan: untuk geolocation berfungsi di browser, jalankan lewat <strong>localhost</strong> (python -m http.server) atau deploy ke HTTPS.</div>
</div>

<script>
/* ---------- Minimal stable implementation ---------- */

/* Expert list (21) */
const EXPERTS = [
  {id:'exp1', label:'Security / Satpam Profesional (sertifikat profesional)'},
  {id:'exp2', label:'Ahli K3 Umum'},
  {id:'exp3', label:'Ahli K3 Konstruksi'},
  {id:'exp4', label:'Ahli K3 Kimia'},
  {id:'exp5', label:'Ahli K3 Listrik'},
  {id:'exp6', label:'Ahli K3 Manufaktur'},
  {id:'exp7', label:'Ahli K3 Minyak dan Gas'},
  {id:'exp8', label:'Ahli Fire Safety / Pemadam Kebakaran'},
  {id:'exp9', label:'Ahli Auditor SMK3'},
  {id:'exp10', label:'Ahli K3 Pertambangan'},
  {id:'exp11', label:'Team Forensik INAFIS'},
  {id:'exp12', label:'Ahli Environmental & Lingkungan Hidup'},
  {id:'exp13', label:'Ahli Arsitek'},
  {id:'exp14', label:'Insinyur Sipil / Struktural (Site Engineer)'},
  {id:'exp15', label:'Konsultan Pengawas (Construction Management)'},
  {id:'exp16', label:'Konsultan Struktur'},
  {id:'exp17', label:'Konsultan M&E (Mechanical & Electrical)'},
  {id:'exp18', label:'Quantity Surveyor (QS)'},
  {id:'exp19', label:'Ahli TKBT (Tenaga Kerja Bangunan Tinggi) level 1 & 2'},
  {id:'exp20', label:'Ahli TKPK (Tenaga Kerja pada Ketinggian) levels 1-3'},
  {id:'exp21', label:'Ahli K3 Spesialis Penanggulangan Kebakaran Tingkat A'}
];

/* small map of blocks for assembly (concise) */
const EXPERT_BLOCKS = {};
EXPERTS.forEach(e=>{
  EXPERT_BLOCKS[e.id] = `ROLE: ${e.label}\nREQUIREMENTS: Provide 2-4 sentence analysis, immediate actions, and step-by-step SOP. Use Indonesian context and recommend verification of legal/standards.`;
});

/* render expert checkboxes (simple grid) */
const expertArea = document.getElementById('expertArea');
EXPERTS.forEach(e=>{
  const div = document.createElement('label');
  div.className = 'expert-item';
  div.innerHTML = `<input type="checkbox" id="${e.id}" value="${e.id}"><div style="font-size:13px">${e.label}</div>`;
  expertArea.appendChild(div);
});

/* file inputs & preview */
const cameraInput = document.getElementById('cameraInput');
const galleryInput = document.getElementById('galleryInput');
const preview = document.getElementById('preview');
let lastImageFile = null;

cameraInput.addEventListener('change', handleFile);
galleryInput.addEventListener('change', handleFile);

function handleFile(e){
  const f = e.target.files[0];
  if(!f) return;
  lastImageFile = f;
  preview.src = URL.createObjectURL(f);
  preview.style.display = 'block';
  // set timestamp now as fallback
  document.getElementById('timestamp').value = new Date().toISOString();
  // try to read EXIF? (omitted to keep stable offline)
}

/* robust geolocation */
document.getElementById('getGeoBtn').addEventListener('click', async ()=>{
  const btn = document.getElementById('getGeoBtn');
  if(!('geolocation' in navigator)){ alert('Geolocation tidak didukung pada browser ini'); return; }
  if(location.protocol === 'file:'){
    if(!confirm('Anda membuka file lokal (file://). Geolocation sering diblokir. Lanjutkan?')) return;
  }
  btn.disabled = true; const orig = btn.textContent; btn.textContent = 'Meminta izin lokasi...';
  try {
    if(navigator.permissions && navigator.permissions.query){
      const perm = await navigator.permissions.query({name:'geolocation'});
      if(perm.state === 'denied'){ alert('Izin lokasi telah ditolak. Aktifkan lewat pengaturan browser.'); btn.disabled=false; btn.textContent=orig; return; }
    }
  } catch(e){}
  navigator.geolocation.getCurrentPosition(pos=>{
    document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
    document.getElementById('lon').value = pos.coords.longitude.toFixed(6);
    btn.disabled=false; btn.textContent=orig;
  }, err=>{
    btn.disabled=false; btn.textContent=orig;
    if(err.code === err.PERMISSION_DENIED) alert('Izin lokasi ditolak. Aktifkan di pengaturan.');
    else if(err.code === err.TIMEOUT) alert('Timeout. Coba lagi.');
    else alert('Gagal ambil lokasi: ' + (err.message||'Unknown'));
  }, {enableHighAccuracy:true,timeout:15000,maximumAge:5000});
});

/* preset minimal (localStorage) */
const PRESET_KEY = 'prompt_final_presets';
function loadPresets(){ try{return JSON.parse(localStorage.getItem(PRESET_KEY)||'{}')}catch(e){return{}} }
function savePresets(p){ localStorage.setItem(PRESET_KEY, JSON.stringify(p)); }
function renderPresets(){ const el=document.getElementById('presetList'); const p=loadPresets(); el.innerHTML=''; const keys=Object.keys(p); if(keys.length===0){ el.textContent='Belum ada preset.'; return; } keys.forEach(k=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='4px 0'; row.innerHTML = `<div>${k}</div><div><input type="radio" name="preset" value="${k}"></div>`; el.appendChild(row); }); }
renderPresets();

document.getElementById('savePresetBtn').addEventListener('click', ()=>{
  const name = document.getElementById('presetName').value.trim();
  if(!name) return alert('Masukkan nama preset.');
  const checked = Array.from(document.querySelectorAll('.expert-item input[type="checkbox"]:checked')).map(i=>i.id);
  if(checked.length===0) return alert('Pilih minimal 1 expert.');
  const p = loadPresets(); p[name]=checked; savePresets(p); renderPresets(); document.getElementById('presetName').value=''; alert('Preset disimpan.');
});
document.getElementById('applyPresetBtn').addEventListener('click', ()=>{
  const sel = document.querySelector('input[name="preset"]:checked'); if(!sel) return alert('Pilih preset terlebih dahulu.');
  const p = loadPresets(); const arr = p[sel.value]||[]; document.querySelectorAll('.expert-item input[type="checkbox"]').forEach(c=>c.checked=false); arr.forEach(id=>{ const el = document.getElementById(id); if(el) el.checked = true; }); alert('Preset diterapkan.');
});
document.getElementById('deletePresetBtn').addEventListener('click', ()=>{
  const sel = document.querySelector('input[name="preset"]:checked'); if(!sel) return alert('Pilih preset untuk dihapus.'); const p = loadPresets(); delete p[sel.value]; savePresets(p); renderPresets(); alert('Preset dihapus.'); 
});

/* --------- Generate prompt (THIS MUST WORK) --------- */
function buildSystemPrompt(aggr){
  if(aggr) return `You are SECURE-EXPERTS-AGGREGATOR — authoritative senior professionals. Answer in Indonesian. BE DIRECT and ACTION-FOCUSED. Return JSON then human-readable report.`;
  return `You are SECURE-EXPERTS-AGGREGATOR — ensemble of senior professionals. Answer in Indonesian. Return JSON then human-readable report.`;
}

document.getElementById('generateBtn').addEventListener('click', ()=>{
  try {
    // collect selected experts
    const checked = Array.from(document.querySelectorAll('.expert-item input[type="checkbox"]:checked')).map(i=>i.id);
    if(checked.length === 0){
      if(!confirm('Tidak ada expert dipilih. Lanjutkan dengan perspektif umum?')) return;
    }
    // structured context
    const ctx = {
      timestamp: document.getElementById('timestamp').value || new Date().toISOString(),
      location: (document.getElementById('lat').value && document.getElementById('lon').value) ? {lat: document.getElementById('lat').value, lon: document.getElementById('lon').value, label: ''} : null,
      image_attached: lastImageFile ? 'Ya' : 'Tidak',
      image_summary: lastImageFile ? 'Foto terlampir' : 'Tidak ada foto',
      notes: document.getElementById('note').value || ''
    };
    // include blocks
    const includeBlocks = checked.map(id => EXPERT_BLOCKS[id] || `ROLE: ${id}\nREQUIREMENTS: ...`).join('\n\n');
    // instructions (strict)
    const instructions = `Instruksi: Untuk setiap expert yang dicentang, berikan Analisa per Ahli (2-4 kalimat). Lalu susun SOP Utama: Immediate actions (1-8), SOP step-by-step (min 6 langkah bila relevan), Protap, Rujukan & Verifikasi, Evidence requested, Decision checklist (5 poin). Output harus dimulai dengan JSON sesuai schema (risk_level, risk_score, analisa_per_ahli, sop_utama, references, evidence_requested, decision_checklist, confidence_overall, verification_notes). Setelah JSON tampilkan laporan manusia (judul & langkah).`;
    // build user message
    const userMessage = `STRUCTURED_CONTEXT:\n${JSON.stringify(ctx, null, 2)}\n\nINCLUDE EXPERT ROLES:\n${includeBlocks || '[No expert blocks selected]'}\n\nINSTRUCTIONS:\n${instructions}`;
    const systemMessage = buildSystemPrompt(document.getElementById('aggressiveToggle').checked);
    const combined = `--- SYSTEM MESSAGE ---\n${systemMessage}\n\n--- USER MESSAGE ---\n${userMessage}`;
    document.getElementById('promptOutput').value = combined;
    // success feedback (no modal)
  } catch (err) {
    console.error('Generate error', err);
    alert('Gagal generate prompt — lihat console (F12) untuk detail.');
  }
});

/* copy buttons */
document.getElementById('copyUserBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('promptOutput').value;
  if(!txt) return alert('Generate dulu.');
  const idx = txt.indexOf('--- USER MESSAGE ---');
  const out = idx>=0 ? txt.slice(idx + '--- USER MESSAGE ---'.length).trim() : txt;
  navigator.clipboard.writeText(out).then(()=> alert('User prompt disalin.'));
});
document.getElementById('copyBothBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('promptOutput').value;
  if(!txt) return alert('Generate dulu.');
  navigator.clipboard.writeText(txt).then(()=> alert('System + User disalin.'));
});

/* mock, download, clear */
document.getElementById('mockBtn').addEventListener('click', ()=>{
  document.getElementById('promptOutput').value = `{\n  "risk_level":"high",\n  "risk_score":85,\n  "analisa_per_ahli":[{"expert":"Security / Satpam Profesional","summary":"...","recommended_immediate_actions":["..."],"confidence":85}],\n  "sop_utama":{ "immediate_actions":["..."], "sop_steps":["1...","2..."], "protap_recommendations":["..."] },\n  "references":["Periksa Peraturan Menteri & SNI"],\n  "evidence_requested":["Foto wide-angle","Timestamp"],\n  "decision_checklist":["Amankan area","Rekam bukti","Verifikasi identitas","Hubungi patroli","Catat & lapor"],\n  "confidence_overall":80,\n  "verification_notes":"Verifikasi hukum pada dokumen resmi."\n}\n\n--- HUMAN-READABLE REPORT ---\nRisk Level & Score: HIGH (85)\nAnalisa per Ahli:\n- Security: ...\nSOP Utama:\n1) ...`;
});
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('promptOutput').value; if(!txt) return alert('Generate dulu.');
  const blob = new Blob([txt], {type:'text/plain'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'prompt.txt'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  preview.src=''; preview.style.display='none'; lastImageFile=null; document.getElementById('lat').value=''; document.getElementById('lon').value=''; document.getElementById('timestamp').value=''; document.getElementById('note').value=''; document.getElementById('promptOutput').value='';
});

/* final: ensure no runtime error on load */
console.log('Prompt Final Fix loaded.');
</script>
</body>
</html>
