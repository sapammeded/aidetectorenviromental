<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Prompt Fix — Upload & Generate Prompt</title>
<style>
  body{font-family:system-ui,Arial;margin:18px;background:#f7f9fc;color:#111}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,0.06);margin-bottom:12px}
  input,textarea,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #d0d7e0}
  button{background:#0b63ff;color:#fff;border:none;font-weight:700;cursor:pointer}
  #preview{max-width:280px;border-radius:8px;display:none;margin-top:8px}
  .muted{font-size:13px;color:#666;margin-top:6px}
</style>
</head>
<body>

<h2>Prompt Fix — Upload Foto → Generate Prompt</h2>
<p class="muted">Simple & pasti jalan. Upload foto lalu tekan "Generate Prompt".</p>

<div class="card">
  <label>1) Pilih/Gunakan Kamera (Upload)</label>
  <input id="fileInput" type="file" accept="image/*" capture="environment">
  <img id="preview" alt="preview" />
</div>

<div class="card">
  <label>2) Data Otomatis (EXIF atau Geolocation)</label>
  <input id="lat" placeholder="Latitude (otomatis jika ada)">
  <input id="lon" placeholder="Longitude (otomatis jika ada)">
  <input id="timestamp" placeholder="Timestamp (otomatis jika ada)">
  <input id="place" placeholder="Nama tempat (optional)">
  <div class="muted">Kalau EXIF tidak ada, tekan tombol ambil GPS perangkat.</div>
  <button id="getGeoBtn" type="button">Ambil GPS Perangkat</button>
</div>

<div class="card">
  <label>3) Info Lokasi / Catatan Singkat (opsional)</label>
  <textarea id="note" placeholder="Tambahkan catatan singkat, mis: 'PT Asusa - Pulo Gadung'"></textarea>
</div>

<div class="card">
  <button id="generateBtn">Generate Prompt</button>
</div>

<div class="card">
  <label>PROMPT (copy → paste ke ChatGPT)</label>
  <textarea id="promptOutput" placeholder="Prompt akan muncul di sini"></textarea>
  <button id="copyBtn">Copy Prompt</button>
</div>

<script>
/* Minimal EXIF reader (tiny): only for GPS fields parsing if EXIF present.
   Uses EXIF.js hosted via CDN automatically if browser supports it.
   But to completely avoid external dependency issues, we try to parse basic EXIF via built-in
   if EXIF lib not loaded; fallback to device geolocation. */

(function(){
  // Try to load exif-js on demand (CDN) but continue if fails
  const exifScript = document.createElement('script');
  exifScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js';
  exifScript.onload = ()=> console.log('EXIF.js loaded');
  exifScript.onerror = ()=> console.log('EXIF.js failed to load (continuing without)');
  document.head.appendChild(exifScript);
})();

const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const latEl = document.getElementById('lat');
const lonEl = document.getElementById('lon');
const tsEl = document.getElementById('timestamp');
const placeEl = document.getElementById('place');
const noteEl = document.getElementById('note');
const generateBtn = document.getElementById('generateBtn');
const promptOutput = document.getElementById('promptOutput');
const copyBtn = document.getElementById('copyBtn');
const getGeoBtn = document.getElementById('getGeoBtn');

let lastImageDataUrl = null;

fileInput.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if(!f) return;
  // preview
  lastImageDataUrl = URL.createObjectURL(f);
  preview.src = lastImageDataUrl;
  preview.style.display = 'block';

  // set timestamp from file (if available)
  try {
    // Try EXIF via EXIF.getData if lib loaded
    if(window.EXIF && EXIF.getData){
      EXIF.getData(f, function(){
        const dt = EXIF.getTag(this, 'DateTimeOriginal') || EXIF.getTag(this, 'DateTime') || null;
        const gpsLat = EXIF.getTag(this, 'GPSLatitude');
        const gpsLon = EXIF.getTag(this, 'GPSLongitude');
        const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
        const lonRef = EXIF.getTag(this, 'GPSLongitudeRef');
        if(dt) {
          // convert format YYYY:MM:DD HH:MM:SS -> ISO
          const iso = dt.replace(/^(\d{4}):(\d{2}):(\d{2})/, '$1-$2-$3');
          tsEl.value = new Date(iso).toISOString();
        }
        if(gpsLat && gpsLon){
          const lat = dmsToDeg(gpsLat, latRef);
          const lon = dmsToDeg(gpsLon, lonRef);
          latEl.value = lat;
          lonEl.value = lon;
        } else {
          // no EXIF GPS
        }
      });
      return;
    }
  } catch(err){
    console.warn('EXIF parsing failed', err);
  }

  // fallback: set timestamp now
  tsEl.value = new Date().toISOString();
});

// convert DMS array to decimal
function dmsToDeg(dms, ref){
  try {
    const d = dms[0].numerator / dms[0].denominator;
    const m = dms[1].numerator / dms[1].denominator;
    const s = dms[2].numerator / dms[2].denominator;
    let dd = d + m/60 + s/3600;
    if(ref === 'S' || ref === 'W') dd = -dd;
    return dd.toFixed(6);
  } catch(e){
    return '';
  }
}

// geolocation fallback
getGeoBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation) return alert('Geolocation tidak didukung di browser ini.');
  getGeoBtn.textContent = 'Mencari lokasi...';
  navigator.geolocation.getCurrentPosition((pos)=>{
    latEl.value = pos.coords.latitude.toFixed(6);
    lonEl.value = pos.coords.longitude.toFixed(6);
    getGeoBtn.textContent = 'Ambil GPS Perangkat';
  }, (err)=>{
    getGeoBtn.textContent = 'Ambil GPS Perangkat';
    alert('Gagal ambil lokasi: ' + err.message);
  }, {enableHighAccuracy:true,timeout:8000});
});

generateBtn.addEventListener('click', ()=>{
  // Build structured context (simple)
  const ctx = {
    timestamp: tsEl.value || new Date().toISOString(),
    location: (latEl.value && lonEl.value) ? {lat: latEl.value, lon: lonEl.value, label: placeEl.value || null} : null,
    place_label: placeEl.value || noteEl.value || null,
    image_attached: !!lastImageDataUrl,
    notes: noteEl.value || ''
  };

  // Build clean prompt for ChatGPT
  const promptLines = [];
  promptLines.push('Anda adalah Ahli Keamanan Profesional.');
  promptLines.push('Analisa data berikut dan buat SOP dan Protap (prosedur operasi tetap) yang praktis, prioritas tindakan, analisa risiko, dan rekomendasi pencegahan:');
  promptLines.push('');
  promptLines.push('=== DATA LOCAION ===');
  if(ctx.location){
    promptLines.push(`Lokasi: ${ctx.location.label || 'Unknown'}`);
    promptLines.push(`Latitude: ${ctx.location.lat}`);
    promptLines.push(`Longitude: ${ctx.location.lon}`);
  } else {
    promptLines.push('Lokasi: Tidak tersedia (tidak ada EXIF GPS).');
  }
  promptLines.push(`Waktu foto / timestamp: ${ctx.timestamp}`);
  if(ctx.place_label) promptLines.push(`Keterangan lokasi: ${ctx.place_label}`);
  if(ctx.notes) promptLines.push(`Catatan tambahan: ${ctx.notes}`);
  promptLines.push('');
  promptLines.push('Berikan output yang rapi dan terstruktur:');
  promptLines.push('- Ringkasan singkat situasi');
  promptLines.push('- Risk level (low/medium/high) + skor 0-100');
  promptLines.push('- Immediate actions (1-6 langkah prioritas)');
  promptLines.push('- SOP singkat (checklist langkah nyata)');
  promptLines.push('- Rekomendasi pencegahan jangka panjang');
  promptLines.push('');
  promptLines.push('Balas hanya dalam bahasa Indonesia dan rapi. Jika data lokasi tidak lengkap, sertakan langkah verifikasi yang jelas.');
  const prompt = promptLines.join('\n');

  promptOutput.value = prompt;
});

// copy
copyBtn.addEventListener('click', ()=>{
  const t = promptOutput;
  t.select();
  document.execCommand('copy');
  alert('Prompt disalin. Paste di ChatGPT/AI lain.');
});
</script>
</body>
</html>
