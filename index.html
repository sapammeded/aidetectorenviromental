<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Prompt Final Fix — Generate Works</title>
<style>
  :root {
    --primary: #0A1931;
    --secondary: #1E3A5F;
    --accent: #0b63ff;
    --accent-dark: #0950d6;
    --light: #f6f9ff;
    --card: #fff;
    --muted: #556070;
    --radius: 10px;
    --shadow: 0 6px 20px rgba(8,20,40,0.06);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
    background: var(--light);
    color: #081227;
    padding: 18px;
    line-height: 1.5;
  }

  .wrap {
    max-width: 1000px;
    margin: 0 auto;
  }

  h1 {
    margin: 0 0 6px;
    font-size: 20px;
    font-weight: 700;
    color: var(--primary);
  }

  .muted {
    color: var(--muted);
    font-size: 13px;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 420px;
    gap: 14px;
    margin-top: 12px;
  }

  @media (max-width: 980px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }

  .card {
    background: var(--card);
    padding: 16px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid rgba(11,99,255,0.04);
    margin-bottom: 12px;
  }

  label {
    display: block;
    font-weight: 700;
    margin-bottom: 6px;
    font-size: 14px;
  }

  input[type="text"], textarea {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #e6eef9;
    background: #fbfdff;
    font-family: inherit;
    font-size: 14px;
  }

  textarea {
    min-height: 180px;
    resize: vertical;
    white-space: pre-wrap;
    line-height: 1.4;
  }

  .row {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
  }

  .col {
    flex: 1;
  }

  button {
    padding: 10px 12px;
    border-radius: 8px;
    border: none;
    background: var(--accent);
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
  }

  button:hover {
    background: var(--accent-dark);
    transform: translateY(-1px);
  }

  button.ghost {
    background: transparent;
    color: var(--accent);
    border: 1px solid rgba(11,99,255,0.12);
  }

  button.ghost:hover {
    background: rgba(11,99,255,0.08);
  }

  .expert-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin: 8px 0;
  }

  .expert-item {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    padding: 10px;
    border-radius: 8px;
    background: #fbfdff;
    border: 1px solid rgba(11,99,255,0.03);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .expert-item:hover {
    background: #f0f5ff;
    border-color: rgba(11,99,255,0.1);
  }

  .expert-item input[type="checkbox"] {
    margin-top: 2px;
  }

  .expert-item div {
    font-size: 12px;
    line-height: 1.4;
    color: var(--muted);
  }

  .small {
    font-size: 13px;
    color: var(--muted);
  }

  .category-header {
    font-weight: 700;
    color: var(--primary);
    margin: 15px 0 8px 0;
    padding-bottom: 5px;
    border-bottom: 2px solid var(--accent);
    font-size: 14px;
  }

  .master-badge {
    background: var(--accent);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    margin-left: 8px;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Prompt Final Fix — Generate Works</h1>
  <div class="muted">Upload foto → pilih expert → Generate → Copy. Kalau butuh GPS, jalankan dari localhost/HTTPS.</div>

  <div class="grid">
    <!-- LEFT -->
    <div>
      <div class="card">
        <label>1) Upload foto (camera / gallery)</label>
        <div class="row">
          <div class="col"><input id="cameraInput" type="file" accept="image/*" capture="environment"></div>
          <div class="col"><input id="galleryInput" type="file" accept="image/*"></div>
        </div>
        <img id="preview" style="display:none;margin-top:10px;max-width:100%;border-radius:8px"/>

        <div style="height:10px"></div>

        <div class="row">
          <div class="col">
            <label>Latitude</label>
            <input id="lat" type="text" placeholder="Latitude (EXIF or device)">
          </div>
          <div class="col">
            <label>Longitude</label>
            <input id="lon" type="text" placeholder="Longitude (EXIF or device)">
          </div>
        </div>

        <div style="height:8px"></div>

        <div class="row">
          <div class="col">
            <label>Timestamp</label>
            <input id="timestamp" type="text" placeholder="Timestamp (ISO)">
          </div>
          <div class="col" style="display:flex;align-items:flex-end;gap:8px">
            <button id="getGeoBtn" class="ghost">Ambil GPS Perangkat</button>
            <button id="clearBtn" class="ghost">Clear</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <label>2) Pilih ahli (boleh multiple) <span class="master-badge">MASTER LEVEL</span></label>
        
        <div class="category-header">K3 & SAFETY</div>
        <div id="expertAreaK3" class="expert-grid"></div>
        
        <div class="category-header">FORENSIK & INVESTIGASI</div>
        <div id="expertAreaForensic" class="expert-grid"></div>
        
        <div class="category-header">ENGINEERING & KONSTRUKSI</div>
        <div id="expertAreaEngineering" class="expert-grid"></div>

        <div style="height:10px"></div>
        <label>Catatan (opsional)</label>
        <textarea id="note" placeholder="Contoh: 'Gerbang rusak, lampu mati, jam 02:12'"></textarea>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <label>Preset (opsional)</label>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="presetName" type="text" placeholder="Nama preset">
          <button id="savePresetBtn" class="ghost">Save</button>
        </div>
        <div id="presetList" style="min-height:80px;border:1px dashed rgba(11,99,255,0.06);padding:8px;border-radius:8px;background:#fff" class="small">Belum ada preset.</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="applyPresetBtn" class="ghost">Apply</button>
          <button id="deletePresetBtn" class="ghost">Delete</button>
        </div>
      </div>

      <div class="card">
        <label>Pengaturan Prompt</label>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <label style="display:flex;align-items:center;gap:8px"><input id="aggressiveToggle" type="checkbox"> Aggressive Mode</label>
        </div>
        <div style="display:flex;gap:8px">
          <button id="generateBtn">Generate Prompt</button>
          <button id="copyUserBtn" class="ghost">Copy User</button>
          <button id="copyBothBtn" class="ghost">Copy System+User</button>
        </div>
      </div>

      <div class="card">
        <label>Hasil Prompt</label>
        <textarea id="promptOutput" placeholder="Tekan Generate untuk membuat prompt..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="mockBtn" class="ghost">Mock Output</button>
          <button id="downloadBtn" class="ghost">Download</button>
        </div>
      </div>
    </div>
  </div>

  <div style="height:10px"></div>
  <div class="muted">Catatan: untuk geolocation berfungsi di browser, jalankan lewat <strong>localhost</strong> (python -m http.server) atau deploy ke HTTPS.</div>
</div>

<script>
/* ---------- Expert list dengan kategori ---------- */
const EXPERTS = [
  // K3 & SAFETY
  {id:'exp1', label:'Security / Satpam Profesional (sertifikat profesional)', category: 'k3'},
  {id:'exp2', label:'Ahli K3 Umum', category: 'k3'},
  {id:'exp3', label:'Ahli K3 Konstruksi', category: 'k3'},
  {id:'exp4', label:'Ahli K3 Kimia', category: 'k3'},
  {id:'exp5', label:'Ahli K3 Listrik', category: 'k3'},
  {id:'exp6', label:'Ahli K3 Manufaktur', category: 'k3'},
  {id:'exp7', label:'Ahli K3 Minyak dan Gas', category: 'k3'},
  {id:'exp8', label:'Ahli Fire Safety / Pemadam Kebakaran', category: 'k3'},
  {id:'exp9', label:'Ahli Auditor SMK3', category: 'k3'},
  {id:'exp10', label:'Ahli K3 Pertambangan', category: 'k3'},
  {id:'exp11', label:'Ahli Environmental & Lingkungan Hidup', category: 'k3'},
  {id:'exp21', label:'Ahli K3 Spesialis Penanggulangan Kebakaran Tingkat A', category: 'k3'},
  
  // FORENSIK & INVESTIGASI
  {id:'exp12', label:'Team Forensik INAFIS', category: 'forensic'},
  
  // ENGINEERING & KONSTRUKSI
  {id:'exp13', label:'Ahli Arsitek', category: 'engineering'},
  {id:'exp14', label:'Insinyur Sipil / Struktural (Site Engineer)', category: 'engineering'},
  {id:'exp15', label:'Konsultan Pengawas (Construction Management)', category: 'engineering'},
  {id:'exp16', label:'Konsultan Struktur', category: 'engineering'},
  {id:'exp17', label:'Konsultan M&E (Mechanical & Electrical)', category: 'engineering'},
  {id:'exp18', label:'Quantity Surveyor (QS)', category: 'engineering'},
  {id:'exp19', label:'Ahli TKBT (Tenaga Kerja Bangunan Tinggi) level 1 & 2', category: 'engineering'},
  {id:'exp20', label:'Ahli TKPK (Tenaga Kerja pada Ketinggian) levels 1-3', category: 'engineering'}
];

/* Expert blocks dengan detail lengkap seperti sebelumnya */
const EXPERT_BLOCKS = {
  'exp1': `ROLE: Security / Satpam Profesional (sertifikat profesional)
REQUIREMENTS: Berikan analisa keamanan 2-4 kalimat, tindakan segera, dan SOP langkah-demi-langkah. Fokus pada pengamanan perimeter, access control, dan patroli. Gunakan konteks Indonesia dan rekomendasikan verifikasi legal/standar.`,

  'exp2': `ROLE: Ahli K3 Umum  
REQUIREMENTS: Berikan analisa K3 komprehensif 2-4 kalimat, identifikasi bahaya, dan SOP pencegahan. Sertakan assessment risiko dan rekomendasi pemenuhan regulasi K3 Indonesia.`,

  'exp3': `ROLE: Ahli K3 Konstruksi
REQUIREMENTS: Analisa bahaya konstruksi spesifik 2-4 kalimat, tindakan pengamanan proyek, dan SOP kerja aman. Fokus pada working at height, perancah, dan peralatan berat.`,

  'exp4': `ROLE: Ahli K3 Kimia
REQUIREMENTS: Identifikasi risiko kimia 2-4 kalimat, penanganan bahan berbahaya, dan SOP emergency response. Sertakan MSDS dan pengendalian paparan.`,

  'exp5': `ROLE: Ahli K3 Listrik
REQUIREMENTS: Analisa bahaya listrik 2-4 kalimat, prosedur LOTO (Lock Out Tag Out), dan SOP kerja dekat instalasi listrik. Pastikan compliance dengan PUIL.`,

  'exp6': `ROLE: Ahli K3 Manufaktur
REQUIREMENTS: Evaluasi risiko manufaktur 2-4 kalimat, pengamanan mesin, dan SOP operasional. Fokus pada machine guarding dan ergonomi.`,

  'exp7': `ROLE: Ahli K3 Minyak dan Gas
REQUIREMENTS: Analisa risiko migas 2-4 kalimat, prosedur area berbahaya, dan SOP confined space. Sertakan HAZOP dan emergency shutdown.`,

  'exp8': `ROLE: Ahli Fire Safety / Pemadam Kebakaran
REQUIREMENTS: Assessment fire risk 2-4 kalimat, tindakan pencegahan kebakaran, dan SOP evakuasi. Fokus pada means of escape dan fire fighting equipment.`,

  'exp9': `ROLE: Ahli Auditor SMK3
REQUIREMENTS: Audit compliance K3 2-4 kalimat, temuan ketidaksesuaian, dan SOP perbaikan. Berdasarkan PP 50/2012 dan standar SMK3.`,

  'exp10': `ROLE: Ahli K3 Pertambangan
REQUIREMENTS: Analisa risiko tambang 2-4 kalimat, pengendalian geoteknik, dan SOP tambang bawah tanah. Sesuai Kepmen ESDM 1827K/2018.`,

  'exp11': `ROLE: Ahli Environmental & Lingkungan Hidup
REQUIREMENTS: Assessment dampak lingkungan 2-4 kalimat, pengendalian pencemaran, dan SOP AMDAL. Fokus pada compliance regulasi lingkungan.`,

  'exp12': `ROLE: Team Forensik INAFIS
REQUIREMENTS: Analisa forensik 2-4 kalimat, pengamanan TKP, dan SOP pengumpulan bukti. Sertakan chain of custody dan preservasi evidence.`,

  'exp13': `ROLE: Ahli Arsitek
REQUIREMENTS: Evaluasi desain arsitektur 2-4 kalimat, aspek fungsionalitas, dan compliance dengan UU 28/2002 tentang Bangunan Gedung.`,

  'exp14': `ROLE: Insinyur Sipil / Struktural (Site Engineer)
REQUIREMENTS: Analisa struktur 2-4 kalimat, integritas bangunan, dan SOP pengawasan konstruksi. Fokus pada structural safety dan quality control.`,

  'exp15': `ROLE: Konsultan Pengawas (Construction Management)
REQUIREMENTS: Assessment manajemen proyek 2-4 kalimat, pengendalian waktu-biaya-mutu, dan SOP pengawasan sesuai PP 29/2000.`,

  'exp16': `ROLE: Konsultan Struktur
REQUIREMENTS: Analisa kekuatan struktur 2-4 kalimat, beban desain, dan perhitungan safety factor. Berdasarkan SNI dan standar IAI.`,

  'exp17': `ROLE: Konsultan M&E (Mechanical & Electrical)
REQUIREMENTS: Evaluasi sistem MEP 2-4 kalimat, kinerja instalasi, dan SOP maintenance. Fokus pada reliability dan safety systems.`,

  'exp18': `ROLE: Quantity Surveyor (QS)
REQUIREMENTS: Analisa biaya konstruksi 2-4 kalimat, pengendalian anggaran, dan SOP pengukuran. Sesuai standar RICS dan metode BOW.`,

  'exp19': `ROLE: Ahli TKBT (Tenaga Kerja Bangunan Tinggi) level 1 & 2
REQUIREMENTS: Assessment kerja ketinggian 2-4 kalimat, pengendalian jatuh, dan SOP harness system. Berdasarkan Permenaker 9/2016.`,

  'exp20': `ROLE: Ahli TKPK (Tenaga Kerja pada Ketinggian) levels 1-3
REQUIREMENTS: Analisa safety kerja ketinggian 2-4 kalimat, sistem penahan jatuh, dan SOP akses tali (rope access).`,

  'exp21': `ROLE: Ahli K3 Spesialis Penanggulangan Kebakaran Tingkat A
REQUIREMENTS: Assessment fire protection 2-4 kalimat, sistem deteksi dan alarm, SOP pemadaman api tingkat lanjut sesuai NFPA.`
};

/* Render expert checkboxes dengan kategori */
function renderExpertsByCategory() {
  const k3Area = document.getElementById('expertAreaK3');
  const forensicArea = document.getElementById('expertAreaForensic');
  const engineeringArea = document.getElementById('expertAreaEngineering');
  
  k3Area.innerHTML = '';
  forensicArea.innerHTML = '';
  engineeringArea.innerHTML = '';

  EXPERTS.forEach(e => {
    const div = document.createElement('label');
    div.className = 'expert-item';
    div.innerHTML = `<input type="checkbox" id="${e.id}" value="${e.id}"><div>${e.label}</div>`;
    
    switch(e.category) {
      case 'k3':
        k3Area.appendChild(div);
        break;
      case 'forensic':
        forensicArea.appendChild(div);
        break;
      case 'engineering':
        engineeringArea.appendChild(div);
        break;
    }
  });
}

/* file inputs & preview */
const cameraInput = document.getElementById('cameraInput');
const galleryInput = document.getElementById('galleryInput');
const preview = document.getElementById('preview');
let lastImageFile = null;

cameraInput.addEventListener('change', handleFile);
galleryInput.addEventListener('change', handleFile);

function handleFile(e){
  const f = e.target.files[0];
  if(!f) return;
  lastImageFile = f;
  preview.src = URL.createObjectURL(f);
  preview.style.display = 'block';
  document.getElementById('timestamp').value = new Date().toISOString();
}

/* robust geolocation */
document.getElementById('getGeoBtn').addEventListener('click', async ()=>{
  const btn = document.getElementById('getGeoBtn');
  if(!('geolocation' in navigator)){ alert('Geolocation tidak didukung pada browser ini'); return; }
  if(location.protocol === 'file:'){
    if(!confirm('Anda membuka file lokal (file://). Geolocation sering diblokir. Lanjutkan?')) return;
  }
  btn.disabled = true; const orig = btn.textContent; btn.textContent = 'Meminta izin lokasi...';
  try {
    if(navigator.permissions && navigator.permissions.query){
      const perm = await navigator.permissions.query({name:'geolocation'});
      if(perm.state === 'denied'){ alert('Izin lokasi telah ditolak. Aktifkan lewat pengaturan browser.'); btn.disabled=false; btn.textContent=orig; return; }
    }
  } catch(e){}
  navigator.geolocation.getCurrentPosition(pos=>{
    document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
    document.getElementById('lon').value = pos.coords.longitude.toFixed(6);
    btn.disabled=false; btn.textContent=orig;
  }, err=>{
    btn.disabled=false; btn.textContent=orig;
    if(err.code === err.PERMISSION_DENIED) alert('Izin lokasi ditolak. Aktifkan di pengaturan.');
    else if(err.code === err.TIMEOUT) alert('Timeout. Coba lagi.');
    else alert('Gagal ambil lokasi: ' + (err.message||'Unknown'));
  }, {enableHighAccuracy:true,timeout:15000,maximumAge:5000});
});

/* preset minimal (localStorage) */
const PRESET_KEY = 'prompt_final_presets';
function loadPresets(){ try{return JSON.parse(localStorage.getItem(PRESET_KEY)||'{}')}catch(e){return{}} }
function savePresets(p){ localStorage.setItem(PRESET_KEY, JSON.stringify(p)); }
function renderPresets(){ const el=document.getElementById('presetList'); const p=loadPresets(); el.innerHTML=''; const keys=Object.keys(p); if(keys.length===0){ el.textContent='Belum ada preset.'; return; } keys.forEach(k=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='4px 0'; row.innerHTML = `<div>${k}</div><div><input type="radio" name="preset" value="${k}"></div>`; el.appendChild(row); }); }

document.getElementById('savePresetBtn').addEventListener('click', ()=>{
  const name = document.getElementById('presetName').value.trim();
  if(!name) return alert('Masukkan nama preset.');
  const checked = Array.from(document.querySelectorAll('.expert-item input[type="checkbox"]:checked')).map(i=>i.id);
  if(checked.length===0) return alert('Pilih minimal 1 expert.');
  const p = loadPresets(); p[name]=checked; savePresets(p); renderPresets(); document.getElementById('presetName').value=''; alert('Preset disimpan.');
});
document.getElementById('applyPresetBtn').addEventListener('click', ()=>{
  const sel = document.querySelector('input[name="preset"]:checked'); if(!sel) return alert('Pilih preset terlebih dahulu.');
  const p = loadPresets(); const arr = p[sel.value]||[]; document.querySelectorAll('.expert-item input[type="checkbox"]').forEach(c=>c.checked=false); arr.forEach(id=>{ const el = document.getElementById(id); if(el) el.checked = true; }); alert('Preset diterapkan.');
});
document.getElementById('deletePresetBtn').addEventListener('click', ()=>{
  const sel = document.querySelector('input[name="preset"]:checked'); if(!sel) return alert('Pilih preset untuk dihapus.'); const p = loadPresets(); delete p[sel.value]; savePresets(p); renderPresets(); alert('Preset dihapus.'); 
});

/* --------- Generate prompt (FUNGSI ASLI DIPERTAHANKAN) --------- */
function buildSystemPrompt(aggr){
  if(aggr) return `You are SECURE-EXPERTS-AGGREGATOR — authoritative senior professionals. Answer in Indonesian. BE DIRECT and ACTION-FOCUSED. Return JSON then human-readable report.`;
  return `You are SECURE-EXPERTS-AGGREGATOR — ensemble of senior professionals. Answer in Indonesian. Return JSON then human-readable report.`;
}

document.getElementById('generateBtn').addEventListener('click', ()=>{
  try {
    // collect selected experts
    const checked = Array.from(document.querySelectorAll('.expert-item input[type="checkbox"]:checked')).map(i=>i.id);
    if(checked.length === 0){
      if(!confirm('Tidak ada expert dipilih. Lanjutkan dengan perspektif umum?')) return;
    }
    // structured context
    const ctx = {
      timestamp: document.getElementById('timestamp').value || new Date().toISOString(),
      location: (document.getElementById('lat').value && document.getElementById('lon').value) ? {lat: document.getElementById('lat').value, lon: document.getElementById('lon').value, label: ''} : null,
      image_attached: lastImageFile ? 'Ya' : 'Tidak',
      image_summary: lastImageFile ? 'Foto terlampir' : 'Tidak ada foto',
      notes: document.getElementById('note').value || ''
    };
    // include blocks - DIPERTAHANKAN DETAIL SEPERTI SEBELUMNYA
    const includeBlocks = checked.map(id => EXPERT_BLOCKS[id] || `ROLE: ${id}\nREQUIREMENTS: ...`).join('\n\n');
    // instructions (strict) - DIPERTAHANKAN SAMA
    const instructions = `Instruksi: Untuk setiap expert yang dicentang, berikan Analisa per Ahli (2-4 kalimat). Lalu susun SOP Utama: Immediate actions (1-8), SOP step-by-step (min 6 langkah bila relevan), Protap, Rujukan & Verifikasi, Evidence requested, Decision checklist (5 poin). Output harus dimulai dengan JSON sesuai schema (risk_level, risk_score, analisa_per_ahli, sop_utama, references, evidence_requested, decision_checklist, confidence_overall, verification_notes). Setelah JSON tampilkan laporan manusia (judul & langkah).`;
    // build user message
    const userMessage = `STRUCTURED_CONTEXT:\n${JSON.stringify(ctx, null, 2)}\n\nINCLUDE EXPERT ROLES:\n${includeBlocks || '[No expert blocks selected]'}\n\nINSTRUCTIONS:\n${instructions}`;
    const systemMessage = buildSystemPrompt(document.getElementById('aggressiveToggle').checked);
    const combined = `--- SYSTEM MESSAGE ---\n${systemMessage}\n\n--- USER MESSAGE ---\n${userMessage}`;
    document.getElementById('promptOutput').value = combined;
  } catch (err) {
    console.error('Generate error', err);
    alert('Gagal generate prompt — lihat console (F12) untuk detail.');
  }
});

/* copy buttons */
document.getElementById('copyUserBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('promptOutput').value;
  if(!txt) return alert('Generate dulu.');
  const idx = txt.indexOf('--- USER MESSAGE ---');
  const out = idx>=0 ? txt.slice(idx + '--- USER MESSAGE ---'.length).trim() : txt;
  navigator.clipboard.writeText(out).then(()=> alert('User prompt disalin.'));
});
document.getElementById('copyBothBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('promptOutput').value;
  if(!txt) return alert('Generate dulu.');
  navigator.clipboard.writeText(txt).then(()=> alert('System + User disalin.'));
});

/* mock, download, clear */
document.getElementById('mockBtn').addEventListener('click', ()=>{
  document.getElementById('promptOutput').value = `{\n  "risk_level":"high",\n  "risk_score":85,\n  "analisa_per_ahli":[{"expert":"Security / Satpam Profesional","summary":"...","recommended_immediate_actions":["..."],"confidence":85}],\n  "sop_utama":{ "immediate_actions":["..."], "sop_steps":["1...","2..."], "protap_recommendations":["..."] },\n  "references":["Periksa Peraturan Menteri & SNI"],\n  "evidence_requested":["Foto wide-angle","Timestamp"],\n  "decision_checklist":["Amankan area","Rekam bukti","Verifikasi identitas","Hubungi patroli","Catat & lapor"],\n  "confidence_overall":80,\n  "verification_notes":"Verifikasi hukum pada dokumen resmi."\n}\n\n--- HUMAN-READABLE REPORT ---\nRisk Level & Score: HIGH (85)\nAnalisa per Ahli:\n- Security: ...\nSOP Utama:\n1) ...`;
});
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('promptOutput').value; if(!txt) return alert('Generate dulu.');
  const blob = new Blob([txt], {type:'text/plain'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'prompt.txt'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  preview.src=''; preview.style.display='none'; lastImageFile=null; document.getElementById('lat').value=''; document.getElementById('lon').value=''; document.getElementById('timestamp').value=''; document.getElementById('note').value=''; document.getElementById('promptOutput').value='';
});

/* Initialize */
renderExpertsByCategory();
renderPresets();
console.log('Prompt Final Fix loaded dengan kategori dan detail expert lengkap.');
</script>
</body>
</html>
