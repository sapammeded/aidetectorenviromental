<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Security SOP Generator ‚Äî DEEPSEEK PRO EDITION</title>

  <style>
    /* ===== DEEPSEEK ENHANCED STYLES ===== */
    :root {
      --primary: #0b3b66;
      --secondary: #0b6b44;
      --accent: #ff8c42;
      --danger: #ff4757;
      --success: #2ed573;
      --warning: #ffa502;
      --dark: #2f3542;
      --light: #f4f7fb;
      --white: #ffffff;
      --shadow: 0 4px 12px rgba(10,20,30,0.15);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #2f3542;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }

    body {
      background-attachment: fixed;
      padding: 8px;
    }

    /* Header dengan glass morphism */
    header {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: var(--dark);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: var(--radius);
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      position: relative;
      z-index: 100;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, #0b3b66, #0b6b44);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .top-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Main container dengan glass effect */
    main {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      position: relative;
      z-index: 1;
    }

    @media (min-width: 1024px) {
      main {
        grid-template-columns: 1fr 1fr;
        grid-template-areas: 
          "camera analysis"
          "editor history";
      }
      #cameraSection { grid-area: camera; }
      #resultSection { grid-area: analysis; }
      #editorSection { grid-area: editor; }
      #historySection { grid-area: history; }
    }

    /* Card design yang modern */
    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(10,20,30,0.2);
    }

    .card h2 {
      margin-bottom: 16px;
      font-size: 18px;
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card h2::before {
      content: "üîí";
      font-size: 16px;
    }

    /* Video styling */
    #video {
      width: 100%;
      height: auto;
      background: linear-gradient(45deg, #2c3e50, #4ca1af);
      border-radius: var(--radius);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: var(--transition);
    }

    #video:hover {
      transform: scale(1.02);
    }

    /* Button system yang robust */
    button {
      padding: 12px 16px;
      border: none;
      border-radius: var(--radius);
      background: linear-gradient(135deg, var(--secondary), #0a8c5a);
      color: var(--white);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(11, 107, 68, 0.3);
    }

    button::before {
      font-size: 14px;
    }

    button:hover:not([disabled]) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(11, 107, 68, 0.4);
      background: linear-gradient(135deg, #0a8c5a, var(--secondary));
    }

    button:active:not([disabled]) {
      transform: translateY(0);
    }

    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      background: #95a5a6;
    }

    /* Specific button icons */
    #startBtn::before { content: "üì∑"; }
    #snapBtn::before { content: "‚≠ï"; }
    #analyzeBtn::before { content: "ü§ñ"; }
    #generateBtn::before { content: "‚ö°"; }
    #exportPdfBtn::before { content: "üìÑ"; }
    #saveJsonBtn::before { content: "üíæ"; }
    #copyClipboardBtn::before { content: "üìã"; }

    /* Camera controls grid */
    .camera-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    /* Form elements */
    input, select, textarea {
      padding: 12px;
      border-radius: var(--radius);
      border: 2px solid #e0e6ef;
      background: var(--white);
      font-family: inherit;
      font-size: 14px;
      transition: var(--transition);
      width: 100%;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(11, 107, 68, 0.1);
    }

    /* Analysis cards */
    .analysis-card {
      background: linear-gradient(135deg, #74b9ff, #0984e3);
      color: white;
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
      transition: var(--transition);
      border-left: 4px solid var(--success);
    }

    .analysis-card:hover {
      transform: translateX(5px);
    }

    .analysis-card h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .analysis-card .score {
      font-weight: bold;
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 20px;
    }

    /* Flex utilities */
    .flex-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .meta-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    /* Modal enhanced */
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      padding: 20px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .modal.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .modal-content {
      background: var(--white);
      padding: 24px;
      border-radius: var(--radius);
      width: 100%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: scale(1);
      transition: transform 0.3s ease;
    }

    .modal.hidden .modal-content {
      transform: scale(0.7);
    }

    /* History items */
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      transition: var(--transition);
    }

    .history-item:hover {
      background: rgba(116, 185, 255, 0.1);
      border-radius: var(--radius);
    }

    /* Progress indicator */
    .progress-bar {
      height: 4px;
      background: linear-gradient(90deg, var(--secondary), var(--success));
      border-radius: 2px;
      margin-top: 8px;
      transition: width 0.3s ease;
    }

    /* Notification system */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      background: var(--success);
      color: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 10001;
      transform: translateX(400px);
      transition: transform 0.4s ease;
      max-width: 300px;
    }

    .notification.show {
      transform: translateX(0);
    }

    /* Loading animation */
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 20px;
      margin-top: 30px;
      color: rgba(255,255,255,0.8);
      font-size: 14px;
    }

    /* Debug button */
    #overlayDebug {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 10001;
      background: var(--danger);
      padding: 10px 14px;
      border-radius: var(--radius);
      color: white;
      border: none;
      opacity: 0.9;
      font-size: 12px;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .camera-controls {
        grid-template-columns: 1fr;
      }
      
      .meta-row {
        grid-template-columns: 1fr;
      }
      
      .flex-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      button {
        justify-content: center;
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --light: #2d3436;
        --white: #2d3436;
        --dark: #dfe6e9;
      }
    }
  
.modal.hidden { display: none !important; opacity: 0 !important; pointer-events: none !important; }
</style>

  <!-- html2pdf for client-side PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
</head>
<body>
  <!-- Notification System -->
  <div id="notification" class="notification" style="display: none;"></div>

  <header>
    <h1>üõ°Ô∏è AI Security SOP Generator ‚Äî DEEPSEEK PRO</h1>
    <div class="top-controls">
      <label for="langToggle" style="color:var(--dark)">ID/EN</label>
      <select id="langToggle" aria-label="Language toggle">
        <option value="id" selected>üáÆüá© Indonesia</option>
        <option value="en">üá∫üá∏ English</option>
      </select>
      <button id="privacyBtn" title="Privacy & settings" style="background:linear-gradient(135deg, var(--accent), #e67e22)">üîí Privacy</button>
    </div>
  </header>

  <main>
    <!-- CAMERA SECTION -->
    <section id="cameraSection" class="card">
      <h2>üì∑ Layar Kamera</h2>
      <video id="video" playsinline autoplay muted></video>
      <div class="progress-bar" id="cameraProgress" style="width: 0%"></div>
      
      <div class="camera-controls">
        <button id="startBtn" type="button">Aktifkan Kamera</button>
        <button id="snapBtn" disabled type="button">Ambil Snapshot</button>
        <button id="analyzeBtn" disabled type="button">Analisa Sekarang</button>
        <label style="display:flex;align-items:center;gap:6px;padding:8px;background:rgba(0,0,0,0.05);border-radius:var(--radius);">
          <input type="checkbox" id="remoteToggle"> üì§ Upload remote
        </label>
        <button id="downloadSnapshotBtn" type="button" style="background:linear-gradient(135deg, #3498db, #2980b9)">üì• Download Snapshot</button>
      </div>
      <canvas id="snapshotCanvas" hidden></canvas>
    </section>

    <!-- ANALYSIS SECTION -->
    <section id="resultSection" class="card">
      <h2>üîç Hasil Analisis</h2>
      <div id="analysisCards" aria-live="polite"></div>

      <div id="manualOverride" style="margin-top:16px;display:none">
        <label for="manualSelect"><strong>Manual pilih kategori:</strong></label>
        <div class="flex-row" style="margin-top:10px">
          <select id="manualSelect" style="flex:1"></select>
          <button id="applyManualBtn" type="button" style="background:linear-gradient(135deg, #e74c3c, #c0392b)">‚úÖ Pilih</button>
        </div>
      </div>
    </section>

    <!-- EDITOR SECTION -->
    <section id="editorSection" class="card">
      <h2>‚úèÔ∏è Editor SOP</h2>
      <div class="meta-row">
        <input id="locationName" placeholder="üè¢ Nama Lokasi (mis. Gerbang Utama)" />
        <input id="dateField" type="date" />
        <select id="versionSelect">
          <option>v1.0</option>
          <option>v1.1</option>
          <option>v2.0</option>
          <option>v2.1</option>
        </select>
      </div>

      <div style="margin-bottom:16px">
        <label><strong>üìù Template SOP (editable)</strong></label>
        <textarea id="sopEditor" placeholder="SOP akan terisi otomatis setelah analisis..." rows="8"></textarea>
      </div>

      <div style="margin-bottom:16px">
        <label><strong>‚úÖ Checklist</strong></label>
        <div id="checklist"></div>
      </div>

      <div class="flex-row">
        <button id="generateBtn">‚ö° Generate SOP</button>
        <button id="exportPdfBtn" disabled>üìÑ Export PDF</button>
        <button id="saveJsonBtn" type="button">üíæ Simpan JSON</button>
        <button id="copyClipboardBtn" type="button">üìã Copy</button>
      </div>
    </section>

    <!-- HISTORY SECTION -->
    <section id="historySection" class="card">
      <h2>üìä History Analisis</h2>
      <div id="historyList"></div>
      <div style="margin-top:16px" class="flex-row">
        <button id="clearHistoryBtn" type="button" style="background:linear-gradient(135deg, var(--danger), #c23616)">üóëÔ∏è Hapus History</button>
        <button id="exportHistoryBtn" type="button" style="background:linear-gradient(135deg, #9b59b6, #8e44ad)">üì§ Export History</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="card" style="background:rgba(255,255,255,0.1);color:white;backdrop-filter:blur(10px);">
      <strong>MODE: DEEPSEEK PRO EDITION</strong> ‚Äî All buttons are 100% clickable with enhanced UX
    </div>
  </footer>

  <!-- PRIVACY MODAL -->
  <div id="privacyModal" class="modal hidden">
    <div class="modal-content">
      <h3 style="margin-bottom:16px;color:var(--primary)">üîí Privacy & Upload Settings</h3>
      <p style="margin-bottom:16px;line-height:1.5">Default: inference di browser (on-device). Jika mengaktifkan "Upload remote", gambar akan dikirim KE SERVER untuk inferensi. Jangan kirim data sensitif tanpa izin.</p>
      <label style="display:flex;gap:10px;align-items:center;margin-bottom:16px;padding:12px;background:rgba(11, 107, 68, 0.1);border-radius:var(--radius);">
        <input type="checkbox" id="confirmRemote"> <strong>Saya mengizinkan upload gambar ke server</strong>
      </label>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="privacyClose" type="button" style="background:linear-gradient(135deg, #95a5a6, #7f8c8d)">Tutup</button>
      </div>
    </div>
  </div>

  <!-- TEMPLATES -->
  <template id="analysisCardTemplate">
    <div class="analysis-card">
      <h3 class="label"></h3>
      <p>Confidence: <span class="score"></span></p>
      <div class="progress-bar" style="width: calc(var(--score) * 100%)"></div>
      <div class="flex-row" style="margin-top:12px">
        <button class="generateSopBtn" type="button">‚ö° Generate SOP</button>
        <button class="viewSnapBtn" type="button" style="background:linear-gradient(135deg, #3498db, #2980b9)">üëÅÔ∏è Lihat Snapshot</button>
      </div>
    </div>
  </template>

  <!-- ========== ENHANCED SCRIPT ========== -->
  <script>
  (function(){
    'use strict';

    /* ========= ENHANCED STATE MANAGEMENT ========= */
    const CATEGORIES = [
      "Gerbang Utama", "Gerbang Samping", "Pintu Masuk", "Resepsionis/Lobby", 
      "Ruang Server", "Pabrik", "Parkiran", "Tangga Darurat", 
      "Lift", "Kamar Hotel", "Koridor/Apartemen", "Gudang"
    ];
    
    const CONF_THRESHOLD = 0.6;
    const HISTORY_KEY = 'ai_sop_history_deepseek_pro';

    // Enhanced element selection
    const elements = {
      video: document.getElementById('video'),
      startBtn: document.getElementById('startBtn'),
      snapBtn: document.getElementById('snapBtn'),
      analyzeBtn: document.getElementById('analyzeBtn'),
      snapshotCanvas: document.getElementById('snapshotCanvas'),
      analysisCards: document.getElementById('analysisCards'),
      manualOverride: document.getElementById('manualOverride'),
      manualSelect: document.getElementById('manualSelect'),
      applyManualBtn: document.getElementById('applyManualBtn'),
      sopEditor: document.getElementById('sopEditor'),
      locationName: document.getElementById('locationName'),
      dateField: document.getElementById('dateField'),
      versionSelect: document.getElementById('versionSelect'),
      checklistDiv: document.getElementById('checklist'),
      generateBtn: document.getElementById('generateBtn'),
      exportPdfBtn: document.getElementById('exportPdfBtn'),
      saveJsonBtn: document.getElementById('saveJsonBtn'),
      copyClipboardBtn: document.getElementById('copyClipboardBtn'),
      historyList: document.getElementById('historyList'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      exportHistoryBtn: document.getElementById('exportHistoryBtn'),
      remoteToggle: document.getElementById('remoteToggle'),
      privacyBtn: document.getElementById('privacyBtn'),
      privacyModal: document.getElementById('privacyModal'),
      privacyClose: document.getElementById('privacyClose'),
      confirmRemote: document.getElementById('confirmRemote'),
      downloadSnapshotBtn: document.getElementById('downloadSnapshotBtn'),
      langToggle: document.getElementById('langToggle'),
      overlayDebug: document.getElementById('overlayDebug'),
      notification: document.getElementById('notification'),
      cameraProgress: document.getElementById('cameraProgress')
    };

    // Enhanced state
    let stream = null;
    let lastSnapshotDataUrl = null;
    let lastAnalysisResults = [];
    let worker = null;

    /* ========= NOTIFICATION SYSTEM ========= */
    function showNotification(message, type = 'success', duration = 3000) {
      const notification = elements.notification;
      notification.textContent = message;
      notification.style.background = type === 'error' ? 
        'linear-gradient(135deg, var(--danger), #c23616)' :
        'linear-gradient(135deg, var(--success), #27ae60)';
      
      notification.style.display = 'block';
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.style.display = 'none', 400);
      }, duration);
    }

    /* ========= ENHANCED CAMERA SYSTEM ========= */
    elements.startBtn.addEventListener('click', async () => {
      try {
        elements.startBtn.innerHTML = '<div class="loader"></div> Memulai Kamera...';
        elements.startBtn.disabled = true;
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          elements.cameraProgress.style.width = progress + '%';
          if (progress >= 90) clearInterval(progressInterval);
        }, 100);

        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }, 
          audio: false 
        });
        
        elements.video.srcObject = stream;
        elements.snapBtn.disabled = false;
        elements.analyzeBtn.disabled = false;
        
        clearInterval(progressInterval);
        elements.cameraProgress.style.width = '100%';
        elements.startBtn.innerHTML = '‚úÖ Kamera Aktif';
        
        showNotification('Kamera berhasil diaktifkan!', 'success');
        
        setTimeout(() => {
          elements.cameraProgress.style.width = '0%';
        }, 1000);
        
      } catch (error) {
        console.error('Camera error:', error);
        elements.startBtn.innerHTML = 'üì∑ Aktifkan Kamera';
        elements.startBtn.disabled = false;
        showNotification('Gagal mengakses kamera: ' + error.message, 'error');
      }
    });

    /* ========= SNAPSHOT SYSTEM ========= */
    elements.snapBtn.addEventListener('click', () => takeSnapshot());
    
    elements.downloadSnapshotBtn.addEventListener('click', () => {
      if (!lastSnapshotDataUrl) {
        showNotification('Belum ada snapshot yang diambil!', 'error');
        return;
      }
      const a = document.createElement('a');
      a.href = lastSnapshotDataUrl;
      a.download = `security_snapshot_${new Date().toISOString().slice(0,19)}.jpg`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      showNotification('Snapshot berhasil didownload!', 'success');
    });

    function takeSnapshot() {
      if (!elements.video.videoWidth) {
        showNotification('Video belum siap. Aktifkan kamera terlebih dahulu!', 'error');
        return;
      }

      const canvas = elements.snapshotCanvas;
      const video = elements.video;
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Add timestamp to snapshot
      ctx.font = '16px Arial';
      ctx.fillStyle = 'white';
      ctx.strokeStyle = 'black';
      ctx.lineWidth = 2;
      const timestamp = new Date().toLocaleString();
      ctx.strokeText(timestamp, 10, canvas.height - 20);
      ctx.fillText(timestamp, 10, canvas.height - 20);
      
      lastSnapshotDataUrl = canvas.toDataURL('image/jpeg', 0.85);
      showNotification('Snapshot berhasil diambil! Klik "Analisa Sekarang"', 'success');
    }

    /* ========= ENHANCED ANALYSIS SYSTEM ========= */
    elements.analyzeBtn.addEventListener('click', async () => {
      if (!lastSnapshotDataUrl) {
        takeSnapshot();
        if (!lastSnapshotDataUrl) return;
      }

      if (elements.remoteToggle.checked && !elements.confirmRemote.checked) {
        showNotification('Harap konfirmasi privacy settings terlebih dahulu!', 'error');
        elements.privacyModal.classList.remove('hidden');
        return;
      }

      elements.analyzeBtn.innerHTML = '<div class="loader"></div> Menganalisa...';
      elements.analyzeBtn.disabled = true;

      // Simulate AI processing with progress
      setTimeout(() => {
        const results = enhancedMockInference();
        handleAnalysisResults(results);
        elements.analyzeBtn.innerHTML = 'ü§ñ Analisa Sekarang';
        elements.analyzeBtn.disabled = false;
      }, 1500);
    });

    function enhancedMockInference() {
      const results = [];
      const usedCategories = new Set();
      
      for (let i = 0; i < 3; i++) {
        let availableCats = CATEGORIES.filter(cat => !usedCategories.has(cat));
        if (availableCats.length === 0) availableCats = CATEGORIES;
        
        const label = availableCats[Math.floor(Math.random() * availableCats.length)];
        usedCategories.add(label);
        
        // More realistic confidence scores
        const baseScore = 0.6 + Math.random() * 0.35;
        const score = Number(baseScore.toFixed(3));
        
        results.push({ 
          label, 
          score,
          details: {
            riskLevel: score > 0.8 ? 'Tinggi' : score > 0.6 ? 'Sedang' : 'Rendah',
            recommendedActions: generateRecommendedActions(label)
          }
        });
      }
      
      // Sort by confidence score
      return results.sort((a, b) => b.score - a.score);
    }

    function generateRecommendedActions(category) {
      const actions = {
        'Gerbang Utama': ['Verifikasi ID pengunjung', 'Pantau CCTV secara real-time', 'Lapor aktivitas mencurigakan'],
        'Ruang Server': ['Check akses log', 'Verifikasi suhu ruangan', 'Backup security system'],
        'Parkiran': ['Pantau plat nomor', 'Check tiket parkir', 'Monitor area gelap']
      };
      return actions[category] || ['Pantau aktivitas', 'Document kejadian', 'Lapor ke supervisor'];
    }

    function handleAnalysisResults(results) {
      lastAnalysisResults = results;
      elements.analysisCards.innerHTML = '';
      
      results.forEach((result, index) => {
        const template = document.getElementById('analysisCardTemplate');
        const card = template.content.cloneNode(true);
        
        card.querySelector('.label').textContent = `${result.label} (${result.details.riskLevel})`;
        card.querySelector('.score').textContent = result.score;
        
        // Set CSS variable for progress bar
        const analysisCard = card.querySelector('.analysis-card');
        analysisCard.style.setProperty('--score', result.score);
        
        // Add enhanced click handlers
        card.querySelector('.generateSopBtn').addEventListener('click', () => {
          showNotification(`Membuat SOP untuk ${result.label}...`, 'success');
          prepareSopFromResult(result);
        });
        
        card.querySelector('.viewSnapBtn').addEventListener('click', () => {
          if (lastSnapshotDataUrl) {
            const newWindow = window.open();
            newWindow.document.write(`
              <html>
                <head><title>Snapshot - ${result.label}</title></head>
                <body style="margin:0;background:#2c3e50;display:flex;justify-content:center;align-items:center;height:100vh;">
                  <img src="${lastSnapshotDataUrl}" style="max-width:100%;max-height:100%;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
                </body>
              </html>
            `);
          } else {
            showNotification('Tidak ada snapshot tersedia!', 'error');
          }
        });
        
        elements.analysisCards.appendChild(card);
      });

      // Show manual override if low confidence
      if (results.length > 0 && results[0].score < CONF_THRESHOLD) {
        elements.manualOverride.style.display = 'block';
        elements.manualSelect.innerHTML = '';
        CATEGORIES.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          elements.manualSelect.appendChild(option);
        });
      } else {
        elements.manualOverride.style.display = 'none';
      }

      saveToHistory({ 
        timestamp: new Date().toISOString(), 
        results, 
        snapshot: lastSnapshotDataUrl 
      });
      
      showNotification('Analisis selesai! Pilih kategori untuk generate SOP.', 'success');
    }

    /* ========= ENHANCED SOP SYSTEM ========= */
    elements.applyManualBtn.addEventListener('click', () => {
      const selected = elements.manualSelect.value;
      if (!selected) {
        showNotification('Pilih kategori terlebih dahulu!', 'error');
        return;
      }
      const manualResult = { 
        label: selected, 
        score: 1.0,
        details: { riskLevel: 'Manual', recommendedActions: [] }
      };
      prepareSopFromResult(manualResult);
    });

    function prepareSopFromResult(result) {
      elements.locationName.value = result.label;
      elements.dateField.valueAsDate = new Date();
      
      const template = generateEnhancedSopTemplate(result.label);
      elements.sopEditor.value = template.sopText;
      renderEnhancedChecklist(template.checklist);
      elements.exportPdfBtn.disabled = false;
      
      showNotification(`SOP untuk ${result.label} berhasil dibuat!`, 'success');
    }

    function generateEnhancedSopTemplate(label) {
      const dateStr = new Date().toLocaleDateString('id-ID', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const sopText = `STANDAR OPERASIONAL PROSEDUR (SOP)
KEAMANAN ${label.toUpperCase()}

Tanggal: ${dateStr}
Lokasi: ${label}
Versi: ${elements.versionSelect.value}

I. TUJUAN
Menjamin keamanan dan keselamatan area ${label}, mencegah akses tidak sah, serta memastikan compliance dengan regulasi keamanan.

II. RUANG LINGKUP
Prosedur ini berlaku untuk semua petugas keamanan yang bertugas di area ${label} selama semua shift operasional.

III. PROSEDUR OPERASIONAL

A. PERSIAPAN SHIFT (15 menit sebelum tugas)
  1. Periksa kelengkapan alat: radio komunikasi, senter, body cam (jika ada)
  2. Pastikan sistem CCTV berfungsi optimal
  3. Review laporan shift sebelumnya
  4. Koordinasi dengan petugas shift sebelumnya

B. MONITORING RUTIN
  1. Lakukan patroli visual setiap 30 menit
  2. Pantau CCTV secara aktif
  3. Dokumentasikan aktivitas mencurigakan
  4. Verifikasi identitas pengunjung/personel

C. TANGGAP DARURAT
  1. Identifikasi ancaman/penyusupan
  2. Aktifkan alarm (jika diperlukan)
  3. Hubungi supervisor & tim respon
  4. Evakuasi sesuai protokol

IV. CHECKLIST HARIAN
  [ ] Pemeriksaan peralatan keamanan
  [ ] Test sistem komunikasi
  [ ] Review access log
  [ ] Update laporan keamanan

V. DOKUMENTASI
Semua aktivitas harus didokumentasikan dalam log book digital dengan timestamp.

Dibuat otomatis oleh AI Security SOP Generator - DeepSeek Pro Edition`;

      const checklist = [
        { label: 'Pemeriksaan peralatan keamanan lengkap', done: false },
        { label: 'Sistem CCTV berfungsi optimal', done: false },
        { label: 'Komunikasi radio aktif', done: false },
        { label: 'Access log terkini', done: false },
        { label: 'Penerangan area memadai', done: false },
        { label: 'Emergency exit clear', done: false }
      ];
      
      return { sopText, checklist };
    }

    function renderEnhancedChecklist(items) {
      elements.checklistDiv.innerHTML = '';
      items.forEach((item, index) => {
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'padding: 10px; margin: 5px 0; background: rgba(0,0,0,0.03); border-radius: 8px;';
        wrapper.innerHTML = `
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="chk_${index}" style="transform: scale(1.2);">
            <span>${item.label}</span>
          </label>
        `;
        elements.checklistDiv.appendChild(wrapper);
      });
    }

    /* ========= ENHANCED EXPORT SYSTEM ========= */
    elements.generateBtn.addEventListener('click', () => {
      if (!elements.locationName.value.trim()) {
        showNotification('Isi nama lokasi terlebih dahulu!', 'error');
        elements.locationName.focus();
        return;
      }

      const template = generateEnhancedSopTemplate(elements.locationName.value);
      elements.sopEditor.value = template.sopText;
      renderEnhancedChecklist(template.checklist);
      elements.exportPdfBtn.disabled = false;
      
      showNotification('SOP berhasil digenerate! Siap untuk export PDF.', 'success');
    });

    elements.exportPdfBtn.addEventListener('click', () => {
      const meta = {
        location: elements.locationName.value || 'Unknown Location',
        date: elements.dateField.value || new Date().toISOString().split('T')[0],
        version: elements.versionSelect.value || 'v1.0'
      };

      const printEl = document.createElement('div');
      printEl.style.cssText = 'padding: 25px; font-family: Arial, sans-serif; color: #2c3e50; max-width: 800px; margin: 0 auto;';
      
      printEl.innerHTML = `
        <div style="text-align: center; border-bottom: 3px solid #0b3b66; padding-bottom: 20px; margin-bottom: 25px;">
          <h1 style="color: #0b3b66; margin: 0;">STANDAR OPERASIONAL PROSEDUR</h1>
          <h2 style="color: #0b6b44; margin: 10px 0;">${meta.location}</h2>
          <p style="color: #7f8c8d;"><strong>Tanggal:</strong> ${meta.date} | <strong>Versi:</strong> ${meta.version}</p>
        </div>
      `;

      if (lastSnapshotDataUrl) {
        printEl.innerHTML += `
          <div style="text-align: center; margin: 20px 0;">
            <img src="${lastSnapshotDataUrl}" style="max-width: 300px; border: 2px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">Snapshot Referensi</p>
          </div>
        `;
      }

      const sopHtml = elements.sopEditor.value.replace(/\n/g, '<br>');
      printEl.innerHTML += `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #0b6b44;">
          <h3 style="color: #0b3b66; margin-top: 0;">PROSEDUR OPERASIONAL</h3>
          <div style="line-height: 1.6;">${sopHtml}</div>
        </div>
      `;

      const checklistItems = Array.from(elements.checklistDiv.querySelectorAll('input[type="checkbox"]'))
        .map((checkbox, index) => {
          const label = checkbox.parentElement.querySelector('span').textContent;
          const status = checkbox.checked ? '‚úÖ' : '‚ùå';
          return `<li style="margin: 8px 0; padding: 5px 0; border-bottom: 1px solid #eee;">${status} ${label}</li>`;
        }).join('');

      printEl.innerHTML += `
        <div style="margin-top: 25px;">
          <h3 style="color: #0b3b66;">CHECKLIST VERIFIKASI</h3>
          <ul style="list-style: none; padding: 0;">${checklistItems}</ul>
        </div>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px dashed #bdc3c7; text-align: center; color: #7f8c8d; font-size: 12px;">
          <p>Dibuat otomatis oleh <strong>AI Security SOP Generator - DeepSeek Pro Edition</strong></p>
          <p>Generated pada: ${new Date().toLocaleString('id-ID')}</p>
        </div>
      `;

      const options = {
        margin: 1,
        filename: `SOP_${meta.location.replace(/\s+/g, '_')}_${meta.date}_${meta.version}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          useCORS: true,
          logging: false
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait' 
        }
      };

      html2pdf().set(options).from(printEl).save();
      showNotification('PDF berhasil diexport!', 'success');
    });

    /* ========= ENHANCED UTILITIES ========= */
    elements.saveJsonBtn.addEventListener('click', () => {
      const payload = buildCurrentSopPayload();
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `SOP_${payload.metadata.location || 'location'}_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification('Data SOP berhasil disimpan sebagai JSON!', 'success');
    });

    elements.copyClipboardBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(elements.sopEditor.value);
        showNotification('SOP berhasil disalin ke clipboard!', 'success');
      } catch (error) {
        showNotification('Gagal menyalin ke clipboard: ' + error.message, 'error');
      }
    });

    function buildCurrentSopPayload() {
      const checklistItems = Array.from(elements.checklistDiv.querySelectorAll('input[type="checkbox"]'))
        .map(checkbox => ({
          label: checkbox.parentElement.querySelector('span').textContent,
          done: checkbox.checked
        }));

      return {
        metadata: {
          location: elements.locationName.value,
          date: elements.dateField.value,
          version: elements.versionSelect.value,
          generatedAt: new Date().toISOString()
        },
        sop: elements.sopEditor.value,
        checklist: checklistItems,
        snapshot: lastSnapshotDataUrl,
        analysis: lastAnalysisResults,
        system: 'DeepSeek Pro Edition v1.0'
      };
    }

    /* ========= ENHANCED HISTORY SYSTEM ========= */
    function saveToHistory(item) {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      history.unshift({
        ...item,
        id: Date.now(),
        location: elements.locationName.value || 'Unknown'
      });
      
      // Keep only last 50 items
      if (history.length > 50) history.length = 50;
      
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      renderEnhancedHistory();
    }

    function renderEnhancedHistory() {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      elements.historyList.innerHTML = '';
      
      if (history.length === 0) {
        elements.historyList.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: #7f8c8d;">
            <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
            <p>Belum ada history analisis</p>
          </div>
        `;
        return;
      }
      
      history.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <div style="flex: 1;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 5px;">
              <strong>${item.location}</strong>
              <small style="color: #7f8c8d; margin-left: 10px;">${new Date(item.timestamp).toLocaleTimeString()}</small>
            </div>
            <div style="font-size: 13px; color: #333;">
              ${item.results.slice(0, 2).map(r => 
                `<span style="display: inline-block; background: ${r.score > 0.7 ? '#27ae60' : r.score > 0.5 ? '#f39c12' : '#e74c3c'}; color: white; padding: 2px 8px; border-radius: 12px; margin: 2px; font-size: 11px;">${r.label} (${r.score})</span>`
              ).join('')}
            </div>
          </div>
        `;
        
        const viewBtn = document.createElement('button');
        viewBtn.innerHTML = 'üëÅÔ∏è View';
        viewBtn.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
        viewBtn.addEventListener('click', () => {
          if (item.snapshot) {
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
              <html>
                <head><title>History Detail - ${item.location}</title></head>
                <body style="font-family: Arial; padding: 20px; background: #f4f7fb;">
                  <h2>Analysis History - ${item.location}</h2>
                  <img src="${item.snapshot}" style="max-width: 100%; border-radius: 8px; margin: 20px 0;">
                  <pre style="background: white; padding: 20px; border-radius: 8px; overflow: auto;">${JSON.stringify(item, null, 2)}</pre>
                </body>
              </html>
            `);
          } else {
            showNotification('Tidak ada snapshot dalam history ini', 'error');
          }
        });
        
        div.appendChild(viewBtn);
        elements.historyList.appendChild(div);
      });
    }

    elements.clearHistoryBtn.addEventListener('click', () => {
      if (confirm('Apakah Anda yakin ingin menghapus semua history analisis?')) {
        localStorage.removeItem(HISTORY_KEY);
        renderEnhancedHistory();
        showNotification('History berhasil dihapus!', 'success');
      }
    });

    elements.exportHistoryBtn.addEventListener('click', () => {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `security_analysis_history_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification('History berhasil diexport!', 'success');
    });

    /* ========= ENHANCED MODAL SYSTEM ========= */
    elements.privacyBtn.addEventListener('click', () => {
      elements.privacyModal.classList.remove('hidden');
    });

    elements.privacyClose.addEventListener('click', () => {
      elements.privacyModal.classList.add('hidden');
    });

    elements.confirmRemote.addEventListener('change', () => {
      if (!elements.confirmRemote.checked) {
        elements.remoteToggle.checked = false;
      }
    });

    /* ========= INITIALIZATION ========= */
    function initializeApp() {
      // Set current date
      elements.dateField.valueAsDate = new Date();
      
      // Load history
      renderEnhancedHistory();
      
      // Initialize modal state
      elements.privacyModal.classList.add('hidden');
      
      // Add keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          elements.saveJsonBtn.click();
        }
        if (e.ctrlKey && e.key === 'p') {
          e.preventDefault();
          elements.exportPdfBtn.click();
        }
      });
      
      showNotification('AI Security SOP Generator siap digunakan!', 'success');
      
      console.log('üöÄ DeepSeek Pro Edition initialized successfully!');
    }

    // Enhanced overlay debug
    elements.overlayDebug.addEventListener('click', () => {
      if (elements.privacyModal.classList.contains('hidden')) {
        elements.privacyModal.classList.remove('hidden');
        elements.overlayDebug.textContent = 'üî¥ Hide Overlay';
      } else {
        elements.privacyModal.classList.add('hidden');
        elements.overlayDebug.textContent = 'üü¢ Toggle Overlay';
      }
    });

    // Initialize when DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }

    // Global helper function
    window.safeKillOverlay = function() {
      elements.privacyModal.classList.add('hidden');
    };

  })();
  </script>
</body>
</html>
